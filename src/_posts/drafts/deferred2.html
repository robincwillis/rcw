<html>
<head>
	<meta charset="UTF-8" />
	<title></title>
</head>
<body>

<script type="text/javascript">

function Deferred(fn){
	var status = 'pending';
	var doneFuncs = [];
	var failedFuncs = [];
	var progressFuncs = [];
	var resultArgs = null;

	var deferred = {
		done : function(){

			for(var i = 0; i < arguments.length; i++){
				if(!arguments[i]){
					continue;
				}
				if(status === 'resolved'){
					arguments[i].appy(this, resultArgs );

				}
				doneFuncs.push(arguments[i]);

			}
			return this;
		},

		then : function(){

			if (arguments.length > 1 && arguments[1]){
				this.fail(arguments[1]);
			}

			if (arguments.length > 0 && arguments[0]){
				this.done(arguments[0]);
			}

		},
		resolveWith : function(context){


			if(status === 'pending'){
				status = 'resolved';
				var args = resultArgs = (arguments.length > 1) ? arguments[1] : [];

				console.log(args);
				console.log(doneFuncs);
				for(var i = 0; i < doneFuncs.length; i++){
					console.log('applying done funcs');
					doneFuncs[i].apply(context, args);
				}
			}
			console.log('resolve called: '  + status)
			return this;
		},

		resolve : function(){
			return this.resolveWith(this, arguments);
		},
		promise : function(){
			return deferred;
		}
		//create : function(obj){
		// 	if(obj == null){
		// 		console.log('ok');
		// 		return promise;
		// 	}else{
		// 		for( var i in promise){
		// 			console.log(i);
		// 			obj[i] = promise[i];
		// 		}
		// 	}
		// 	return obj;
		// }

	};

	//console.log(deferred);
	var obj = deferred.promise();

	if(fn){
		fn.apply(obj, [obj]);
	}else{
		//console.log('made a new deferred');
	}
	return obj;
}

Deferred.when = function(){
	//console.log(arguments);
	console.log('when called');
	//var obj = arguments.length ? arguments[0] : undefined;
	//return obj.promise();
	return(function(args){
		var df = Deferred();
		var size = args.length;
		var done = 0;
		var rp = new Array(args.length);

		for(var i = 0; i < args.length; i ++){
			(function(j){

				if(args[j].done){
					args[j].done(function(){
					rp[j] = (arguments.length < 2) ? arguments[0] : arguments;						if(++ done == args.length){
							console.log(rp);
							df.resolve.apply(df, rp);
						}
					})
				}
			})(i)
		}
		return df.promise();
	})(arguments);

}

Deferred.then = function(){
	console.log('then called');
}

//made a new defered

function someFunc(){
	var dfd = new Deferred();
	//console.log(dfd);
	setTimeout(function(){
		console.log("RESOLVING 1");
		dfd.resolve('my resolve message');
	}, Math.floor(Math.random()*1500));
	return dfd.promise();
}

function someOtherFunc(){
	var dfd = new Deferred();
	//console.log(dfd);
	setTimeout(function(){
		console.log("RESOLVING 2");
		dfd.resolve('my other resolve message');
	}, Math.floor(Math.random()*1500));
	return dfd.promise();
}

Deferred.when(someFunc(), someOtherFunc()).then(
	function(status, status2){
		console.log('things all good good' + status  + ":" + status2)
	},
	function(status){
		console.log('things bad');
	}
);



</script>


	<script type="text/javascript">

	// 	var test = function(){

	// 		console.log("doing test");

	// 		return({

	// 		});
	// 		// return (function(args){
	// 		// 		console.log('function is getting executed');
	// 		// 		console.log(arguments);
	// 		// })(arguments);
	// 	};

	// var t =	test("asdf", "bob");
	// //console.log(t);
	// //t();

	// 	// creates a function object
	// var f1 = (function() { console.log('foo1'); });

	// // creates a function object and executes it immediately
	// var f2 = (function() { console.log('foo2'); }());

	// var f3 = function() { console.log('foo3'); };
	// var f4 = function() { console.log('foo4'); }();
	// console.log(f1);
	// console.log(f3);

	</script>

</body>
</html>